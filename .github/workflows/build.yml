name: Build KernelSU Kernel for SM-M127F

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y git bc bison flex libssl-dev make libc6-dev libncurses5-dev crossbuild-essential-arm64 python3 zip unzip libelf-dev gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu ccache

    - name: Clone kernel source
      run: |
        git clone --depth=1 https://github.com/maazm7d/kernel_samsung_m12 kernel
        cd kernel && echo "Commit: $(git log --oneline -1)"

    - name: Fix Mali GPU Kconfig
      run: |
        echo "Y29uZmlnIE1BTElfRERLX1ZFUlNJT04KCWJvb2wgIkVuYWJsZSBNQUxJIERESyBWZXJzaW9uIFNlbGVjdGlvbiIKCWRlZmF1bHQgeQoKaWYgTUFMSV9EREtfVkVSU0lPTgpjaG9pY2UKCXByb21wdCAidmVyc2lvbiBDb25maWd1cmF0aW9uIgoJZGVwZW5kcyBvbiBNQUxJX0RES19WRVJTSU9OCglkZWZhdWx0IE1BTElfQklGUk9TVF9SMjZQMAoJaGVscAoJICBTZWxlY3QgdGhlIGdwdSBzdXBwb3J0IHZlcnNpb24uCmNvbmZpZyBNQUxJX0JJRlJPU1RfUjE5UDAKCWRlcGVuZHMgb24gTUFMSV9EREtfVkVSU0lPTgoJYm9vbCAiQmlmcm9zdCByMTlwMCBkcml2ZXIiCmNvbmZpZyBNQUxJX0JJRlJPU1RfUjI2UDAKCWRlcGVuZHMgb24gTUFMSV9EREtfVkVSU0lPTgoJYm9vbCAiQmlmcm9zdCByMjZwMCBkcml2ZXIiCmNvbmZpZyBNQUxJX0JJRlJPU1RfUjMyUDEKCWRlcGVuZHMgb24gTUFMSV9EREtfVkVSU0lPTgoJYm9vbCAiQmlmcm9zdCByMzJwMSBkcml2ZXIiCmNvbmZpZyBNQUxJX0JJRlJPU1RfUjM4UDEKCWRlcGVuZHMgb24gTUFMSV9EREtfVkVSU0lPTgoJYm9vbCAiQmlmcm9zdCByMzhwMSBkcml2ZXIiCmVuZGNob2ljZQplbmRpZgo=" | base64 -d > kernel/drivers/gpu/arm/Kconfig
        echo "Kconfig fixed"

    - name: Apply KernelSU patch
      run: |
        cd kernel
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Configure kernel
      run: |
        cd kernel
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- universal3830_defconfig
        scripts/config --enable CONFIG_KSU
        scripts/config --enable CONFIG_OVERLAY_FS
        scripts/config --disable CONFIG_LOCALVERSION_AUTO
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        grep "CONFIG_KSU" .config

    - name: Build kernel
      run: |
        cd kernel
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC=aarch64-linux-gnu-gcc -j$(nproc) Image 2>&1 | tail -150
        ls -lh arch/arm64/boot/Image

    - name: Clone AnyKernel3
      run: git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel

    - name: Package kernel
      run: |
        cp kernel/arch/arm64/boot/Image anykernel/
        echo "ZHVtcF9ib290OwpwYXRjaF9jbWRsaW5lICJhbmRyb2lkYm9vdC5zZWxpbnV4IiAiYW5kcm9pZGJvb3Quc2VsaW51eD1wZXJtaXNzaXZlIjsKcGF0Y2hfY21kbGluZSAic2VsaW51eCIgInNlbGludXg9MCI7CnBhdGNoX2NtZGxpbmUgImVuZm9yY2luZyIgImVuZm9yY2luZz0wIjsKcGF0Y2hfY21kbGluZSAienJhbS5udW1fZGV2aWNlcyIgInpyYW0ubnVtX2RldmljZXM9MSI7CndyaXRlX2Jvb3Q7" | base64 -d > /tmp/ak_cmds.sh
        printf 'kernel.string=SM-M127F KernelSU Kernel\ndo.devicecheck=1\ndo.modules=0\ndo.systemless=1\ndo.cleanup=1\ndo.cleanuponabort=0\ndevice.name1=m12\ndevice.name2=m12nacho\ndevice.name3=SM-M127F\nsupported.versions=11\n\n. tools/ak3-core.sh\n\n' > anykernel/anykernel.sh
        cat /tmp/ak_cmds.sh >> anykernel/anykernel.sh
        cd anykernel && zip -r9 ../SM-M127F_KernelSU.zip . -x "*.git*" "*.github*" "*.md"
        ls -lh ../SM-M127F_KernelSU.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SM-M127F_KernelSU
        path: SM-M127F_KernelSU.zip
        retention-days: 7
