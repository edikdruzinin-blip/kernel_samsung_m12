name: Build KernelSU Kernel for SM-M127F

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y git bc bison flex libssl-dev make libc6-dev libncurses5-dev crossbuild-essential-arm64 python3 zip unzip libelf-dev gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu ccache

    - name: Clone kernel source
      run: |
        git clone --depth=1 https://github.com/maazm7d/kernel_samsung_m12 kernel
        cd kernel && echo "Commit: $(git log --oneline -1)"

    - name: Fix Mali GPU Kconfig
      run: |
        echo "Y29uZmlnIE1BTElfRERLX1ZFUlNJT04KCWJvb2wgIkVuYWJsZSBNQUxJIERESyBWZXJzaW9uIFNlbGVjdGlvbiIKCWRlZmF1bHQgeQoKaWYgTUFMSV9EREtfVkVSU0lPTgpjaG9pY2UKCXByb21wdCAidmVyc2lvbiBDb25maWd1cmF0aW9uIgoJZGVwZW5kcyBvbiBNQUxJX0RES19WRVJTSU9OCglkZWZhdWx0IE1BTElfQklGUk9TVF9SMjZQMAoJaGVscAoJICBTZWxlY3QgdGhlIGdwdSBzdXBwb3J0IHZlcnNpb24uCmNvbmZpZyBNQUxJX0JJRlJPU1RfUjE5UDAKCWRlcGVuZHMgb24gTUFMSV9EREtfVkVSU0lPTgoJYm9vbCAiQmlmcm9zdCByMTlwMCBkcml2ZXIiCmNvbmZpZyBNQUxJX0JJRlJPU1RfUjI2UDAKCWRlcGVuZHMgb24gTUFMSV9EREtfVkVSU0lPTgoJYm9vbCAiQmlmcm9zdCByMjZwMCBkcml2ZXIiCmNvbmZpZyBNQUxJX0JJRlJPU1RfUjMyUDEKCWRlcGVuZHMgb24gTUFMSV9EREtfVkVSU0lPTgoJYm9vbCAiQmlmcm9zdCByMzJwMSBkcml2ZXIiCmNvbmZpZyBNQUxJX0JJRlJPU1RfUjM4UDEKCWRlcGVuZHMgb24gTUFMSV9EREtfVkVSU0lPTgoJYm9vbCAiQmlmcm9zdCByMzhwMSBkcml2ZXIiCmVuZGNob2ljZQplbmRpZgo=" | base64 -d > kernel/drivers/gpu/arm/Kconfig

    - name: Fix Samsung build errors
      run: |
        cd kernel
        sed -i "s/static bool __init_or_module initcall_sec_debug/static bool initcall_sec_debug/" init/main.c
        sed -i 's/panic("fail to freeze tasks: %s", secdbg_exin_get_unfz());/panic("fail to freeze tasks");/' kernel/power/process.c
        sed -i 's/if (sb->s_magic == F2FS_SUPER_MAGIC)/if (sb->s_magic == 0xF2F52010UL)/' fs/super.c

        # Fix sensorhub firmware: disable it if no firmware dir
        if grep -r "shub_nacho_bl" firmware/Makefile 2>/dev/null; then
            sed -i '/shub_nacho/d' firmware/Makefile
        fi
        echo "ZiA9IG9wZW4oJ2luY2x1ZGUvbGludXgvbW0uaCcsICdyJykKY29udGVudCA9IGYucmVhZCgpCmYuY2xvc2UoKQpjb250ZW50ID0gY29udGVudC5yZXBsYWNlKAogICAgJ2V4dGVybiBpbmxpbmUgYm9vbCBuZWVkX21lbW9yeV9ib29zdGluZyhzdHJ1Y3QgcGdsaXN0X2RhdGEgKnBnZGF0KTsnLAogICAgJy8qIG5lZWRfbWVtb3J5X2Jvb3N0aW5nIGRlZmluZWQgaW4gbW0vdm1zY2FuLmMgKi8nCikKb3BlbignaW5jbHVkZS9saW51eC9tbS5oJywgJ3cnKS53cml0ZShjb250ZW50KQpwcmludCgnbW0uaCBwYXRjaGVkJykK" | base64 -d > /tmp/patch_mm.py && python3 /tmp/patch_mm.py
        echo "aW1wb3J0IHJlCmYgPSBvcGVuKCdrZXJuZWwvc2NoZWQvY29yZS5jJywgJ3InKQpjb250ZW50ID0gZi5yZWFkKCkKZi5jbG9zZSgpCmNvbnRlbnQgPSByZS5zdWIocidbXlxuXSpydW5fZGVsYXlfbmV4dF90YXNrW15cbl0qXG4nLCAnJywgY29udGVudCkKY29udGVudCA9IHJlLnN1YihyJ1teXG5dKmxhc3Rfc3VtX3J1bl9kZWxheVteXG5dKlxuJywgJycsIGNvbnRlbnQpCmNvbnRlbnQgPSByZS5zdWIocidbXlxuXSpcLnJ1bl9kZWxheVteXG5dKlxuJywgJycsIGNvbnRlbnQpCm9wZW4oJ2tlcm5lbC9zY2hlZC9jb3JlLmMnLCAndycpLndyaXRlKGNvbnRlbnQpCnByaW50KCdzY2hlZC9jb3JlLmMgcGF0Y2hlZCcpCg==" | base64 -d > /tmp/patch_sched.py && python3 /tmp/patch_sched.py
        # Create stub file for missing Samsung/platform symbols in init/
        echo "LyogU2Ftc3VuZy9wbGF0Zm9ybSBzeW1ib2wgc3R1YnMgLSBwbGFjZWQgaW4gaW5pdC8gZm9yIGNsZWFuIGNvbXBpbGF0aW9uICovCiNpbmNsdWRlIDxsaW51eC9rZXJuZWwuaD4KI2luY2x1ZGUgPGxpbnV4L2Vycm5vLmg+CiNpbmNsdWRlIDxsaW51eC9leHBvcnQuaD4KCi8qIEVNUyBzY2hlZHVsZXIgc3R1YnMgKi8KaW50IF9fd2VhayBzY2hlZHR1bmVfdGFza19tYXJnaW4odm9pZCAqcCwgdW5zaWduZWQgbG9uZyB1dGlsKSB7IHJldHVybiAwOyB9CmludCBfX3dlYWsgbGJfY2ZzX3Rhc2tzKHZvaWQgKnJxLCBpbnQgY3B1KSB7IHJldHVybiAwOyB9CgovKiBTYW1zdW5nIHBlci1jcHUgdGljayAqLwp2b2lkIF9fd2VhayByZXN0b3JlX3BjcHVfdGljayh1bnNpZ25lZCBpbnQgY3B1KSB7fQp2b2lkIF9fd2VhayBzYXZlX3BjcHVfdGljayh1bnNpZ25lZCBpbnQgY3B1KSB7fQoKLyogSU9OIG1lbW9yeSAqLwp2b2lkIF9fd2VhayBpb25fYWNjb3VudF9wcmludF91c2FnZSh2b2lkKSB7fQoKLyogTENEIHN0YXRlICovCmludCBsY2RfaXNfb24gPSAxOwpFWFBPUlRfU1lNQk9MKGxjZF9pc19vbik7CgovKiBTYW1zdW5nIGJvb3RzdGF0ICovCnZvaWQgX193ZWFrIHNlY19ib290c3RhdF9nZXRfY3B1aW5mbyhjaGFyICpidWYpIHsgaWYgKGJ1ZikgYnVmWzBdID0gMDsgfQp2b2lkIF9fd2VhayBzZWNfYm9vdHN0YXRfZ2V0X3RoZXJtYWwoY2hhciAqYnVmKSB7IGlmIChidWYpIGJ1ZlswXSA9IDA7IH0KCi8qIFNhbXN1bmcgc2VjZGJnICovCnZvaWQgX193ZWFrIHNlY2RiZ19iYXNlX2NsZWFyX21hZ2ljX3JhbWJhc2Uodm9pZCkge30KCi8qIFJUQyBoZWxwZXIgKi8KI2luY2x1ZGUgPGxpbnV4L3RpbWUuaD4Kdm9pZCBfX3dlYWsgcnRjX3RpbWU2NF90b190bShzNjQgdGltZSwgc3RydWN0IHRtICp0bSkKewoJaWYgKHRtKSBtZW1zZXQodG0sIDAsIHNpemVvZigqdG0pKTsKfQpFWFBPUlRfU1lNQk9MKHJ0Y190aW1lNjRfdG9fdG0pOwoKLyogSUlPIHN0dWJzICovCnZvaWQgX193ZWFrICppaW9fY2hhbm5lbF9nZXQodm9pZCAqZGV2LCBjb25zdCBjaGFyICpjaCkgeyByZXR1cm4gTlVMTDsgfQppbnQgX193ZWFrIGlpb19yZWFkX2NoYW5uZWxfcHJvY2Vzc2VkKHZvaWQgKmNoYW4sIGludCAqdmFsKSB7IHJldHVybiAtRU5PREVWOyB9CnZvaWQgX193ZWFrIGlpb19jaGFubmVsX3JlbGVhc2Uodm9pZCAqY2hhbikge30K" | base64 -d > init/samsung_stubs.c
        echo 'obj-y += samsung_stubs.o' >> init/Makefile
        # Remove the wrong entry from root Makefile if it exists
        sed -i '/samsung_stubs/d' Makefile 2>/dev/null || true
        echo "Stubs created in init/"
        echo "Stubs created"

    - name: Apply KernelSU patch
      run: |
        cd kernel
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Configure kernel
      run: |
        cd kernel
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- universal3830_defconfig
        # Disable module support - forces ALL =m drivers to become =y (built into Image)
        scripts/config --disable CONFIG_MODULES
        # Explicitly enable key Exynos 850 SoC drivers
        scripts/config --enable CONFIG_MMC_DW
        scripts/config --enable CONFIG_MMC_DW_EXYNOS
        scripts/config --enable CONFIG_EXYNOS_THERMAL
        scripts/config --enable CONFIG_PINCTRL_EXYNOS
        scripts/config --enable CONFIG_FB
        scripts/config --enable CONFIG_I2C
        scripts/config --enable CONFIG_SPI
        scripts/config --enable CONFIG_REGULATOR
        scripts/config --enable CONFIG_MFD_SYSCON
        scripts/config --enable CONFIG_DRM_EXYNOS
        scripts/config --enable CONFIG_KSU
        scripts/config --enable CONFIG_OVERLAY_FS
        scripts/config --disable CONFIG_LOCALVERSION_AUTO
        scripts/config --set-str CONFIG_EXTRA_FIRMWARE ""
        scripts/config --set-str CONFIG_EXTRA_FIRMWARE_DIR ""
        scripts/config --disable CONFIG_EXYNOS_BTS
        scripts/config --disable CONFIG_SENSORS_SSP
        scripts/config --disable CONFIG_SHUB
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        echo "=== Config stats: $(grep -c '=y' .config) built-in, $(grep -c '=m' .config 2>/dev/null || echo 0) modules ==="

    - name: Build kernel
      run: |
        cd kernel
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- CC=aarch64-linux-gnu-gcc KCFLAGS="-w" -j$(nproc) Image 2>&1 | tee /tmp/build.log; true
        echo "=== ERRORS ==="
        grep -E "^.*(error:|Error [0-9]|undefined reference)" /tmp/build.log | head -50 || true
        echo "=== END ERRORS ==="
        ls -lh arch/arm64/boot/Image

    - name: Clone AnyKernel3
      run: git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel

    - name: Package kernel
      run: |
        cp kernel/arch/arm64/boot/Image anykernel/
        echo "a2VybmVsLnN0cmluZz1TTS1NMTI3RiBLZXJuZWxTVSBLZXJuZWwKZG8uZGV2aWNlY2hlY2s9MQpkby5tb2R1bGVzPTAKZG8uc3lzdGVtbGVzcz0xCmRvLmNsZWFudXA9MQpkby5jbGVhbnVwb25hYm9ydD0wCmRldmljZS5uYW1lMT1tMTIKZGV2aWNlLm5hbWUyPW0xMm5hY2hvCmRldmljZS5uYW1lMz1TTS1NMTI3RgpzdXBwb3J0ZWQudmVyc2lvbnM9MTEKCi4gdG9vbHMvYWszLWNvcmUuc2gKCmR1bXBfYm9vdDsKcGF0Y2hfY21kbGluZSAiYW5kcm9pZGJvb3Quc2VsaW51eCIgImFuZHJvaWRib290LnNlbGludXg9cGVybWlzc2l2ZSI7CnBhdGNoX2NtZGxpbmUgInNlbGludXgiICJzZWxpbnV4PTAiOwpwYXRjaF9jbWRsaW5lICJlbmZvcmNpbmciICJlbmZvcmNpbmc9MCI7CnBhdGNoX2NtZGxpbmUgInpyYW0ubnVtX2RldmljZXMiICJ6cmFtLm51bV9kZXZpY2VzPTEiOwp3cml0ZV9ib290Owo=" | base64 -d > anykernel/anykernel.sh
        cd anykernel && zip -r9 ../SM-M127F_KernelSU.zip . -x "*.git*" "*.github*" "*.md"
        ls -lh ../SM-M127F_KernelSU.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SM-M127F_KernelSU
        path: SM-M127F_KernelSU.zip
        retention-days: 7
