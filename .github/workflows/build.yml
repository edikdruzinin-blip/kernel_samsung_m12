name: Build KernelSU Kernel for SM-M127F

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          git bc bison flex libssl-dev make libc6-dev libncurses5-dev \
          crossbuild-essential-arm64 python3 zip unzip \
          libelf-dev gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu \
          ccache

    - name: Clone kernel source
      run: |
        git clone --depth=1 \
          https://github.com/maazm7d/kernel_samsung_m12 \
          kernel
        cd kernel
        echo "Commit: $(git log --oneline -1)"

    - name: Fix Mali GPU Kconfig
      run: |
        cd kernel
        cat > drivers/gpu/arm/Kconfig << 'KCONFIG_EOF'
config MALI_DDK_VERSION
  bool "Enable MALI DDK Version Selection"
  default y

if MALI_DDK_VERSION
choice
  prompt "version Configuration"
  depends on MALI_DDK_VERSION
  default MALI_BIFROST_R26P0
  help
    Select the gpu support version.
config MALI_BIFROST_R19P0
  depends on MALI_DDK_VERSION
  bool "Bifrost r19p0 driver"
config MALI_BIFROST_R26P0
  depends on MALI_DDK_VERSION
  bool "Bifrost r26p0 driver"
config MALI_BIFROST_R32P1
  depends on MALI_DDK_VERSION
  bool "Bifrost r32p1 driver"
config MALI_BIFROST_R38P1
  depends on MALI_DDK_VERSION
  bool "Bifrost r38p1 driver"
endchoice
endif
KCONFIG_EOF

    - name: Apply KernelSU patch
      run: |
        cd kernel
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -

    - name: Configure kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- universal3830_defconfig
        scripts/config --enable CONFIG_KSU
        scripts/config --enable CONFIG_OVERLAY_FS
        scripts/config --disable CONFIG_LOCALVERSION_AUTO
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- olddefconfig
        grep "CONFIG_KSU" .config

    - name: Build kernel
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        export CC=aarch64-linux-gnu-gcc
        export LD=aarch64-linux-gnu-ld
        export AR=aarch64-linux-gnu-ar
        export NM=aarch64-linux-gnu-nm
        export OBJCOPY=aarch64-linux-gnu-objcopy
        export OBJDUMP=aarch64-linux-gnu-objdump
        make ARCH=arm64 \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CC=aarch64-linux-gnu-gcc \
          -j$(nproc) Image 2>&1 | tail -150
        ls -lh arch/arm64/boot/Image

    - name: Clone AnyKernel3
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel

    - name: Package kernel
      run: |
        cp kernel/arch/arm64/boot/Image anykernel/
        printf '%s\n' \
          'kernel.string=SM-M127F KernelSU Kernel' \
          'do.devicecheck=1' \
          'do.modules=0' \
          'do.systemless=1' \
          'do.cleanup=1' \
          'do.cleanuponabort=0' \
          'device.name1=m12' \
          'device.name2=m12nacho' \
          'device.name3=SM-M127F' \
          'supported.versions=11' \
          '' \
          '. tools/ak3-core.sh' \
          '' \
          'dump_boot;' \
          'patch_cmdline "androidboot.selinux" "androidboot.selinux=permissive";' \
          'patch_cmdline "selinux" "selinux=0";' \
          'patch_cmdline "enforcing" "enforcing=0";' \
          'patch_cmdline "zram.num_devices" "zram.num_devices=1";' \
          'write_boot;' > anykernel/anykernel.sh
        cd anykernel
        zip -r9 ../SM-M127F_KernelSU.zip . -x "*.git*" "*.github*" "*.md"
        ls -lh ../SM-M127F_KernelSU.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: SM-M127F_KernelSU
        path: SM-M127F_KernelSU.zip
        retention-days: 7
